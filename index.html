<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatServer — Real-time Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- ── LOGIN SCREEN ── -->
  <div id="login-screen" class="screen">
    <div class="login-card">
      <div class="login-logo">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
          <rect width="40" height="40" rx="12" fill="#4f8ef7"/>
          <path d="M8 12h24v14a3 3 0 0 1-3 3H11a3 3 0 0 1-3-3V12z" fill="white" fill-opacity=".9"/>
          <path d="M14 29l3-3h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <rect x="13" y="17" width="4" height="2" rx="1" fill="#4f8ef7"/>
          <rect x="20" y="17" width="7" height="2" rx="1" fill="#4f8ef7"/>
          <rect x="13" y="21" width="10" height="2" rx="1" fill="#4f8ef7"/>
        </svg>
      </div>
      <h1>ChatServer</h1>
      <p class="login-sub">Real-time · No accounts · No passwords</p>

      <div class="input-group">
        <input
          id="username-input"
          type="text"
          placeholder="Choose a username…"
          maxlength="24"
          autocomplete="off"
          spellcheck="false"
        />
        <button id="join-btn">Join</button>
      </div>
      <p class="login-hint">Your username is stored locally. No password needed.</p>
    </div>
  </div>

  <!-- ── CHAT SCREEN ── -->
  <div id="chat-screen" class="screen hidden">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-top">
        <div class="sidebar-brand">
          <svg width="22" height="22" viewBox="0 0 40 40" fill="none">
            <rect width="40" height="40" rx="10" fill="#4f8ef7"/>
            <path d="M8 12h24v14a3 3 0 0 1-3 3H11a3 3 0 0 1-3-3V12z" fill="white" fill-opacity=".9"/>
            <path d="M14 29l3-3h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <rect x="13" y="17" width="4" height="2" rx="1" fill="#4f8ef7"/>
            <rect x="20" y="17" width="7" height="2" rx="1" fill="#4f8ef7"/>
            <rect x="13" y="21" width="10" height="2" rx="1" fill="#4f8ef7"/>
          </svg>
          <span class="brand-name">ChatServer</span>
        </div>

        <div class="sidebar-me">
          <span class="presence-dot online"></span>
          <span id="me-label" class="me-name"></span>
          <button id="change-name-btn" title="Change username" class="icon-btn">&#9998;</button>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-header">
          <span>CHANNELS</span>
          <button id="add-room-btn" class="icon-btn" title="New channel">+</button>
        </div>
        <ul id="room-list"></ul>
      </nav>

      <div class="sidebar-online">
        <div class="nav-section-header">
          <span>ONLINE — <span id="online-count">0</span></span>
        </div>
        <ul id="user-list"></ul>
      </div>
    </aside>

    <!-- Main chat -->
    <div class="chat-wrap">
      <header class="chat-header">
        <button id="menu-btn" class="icon-btn menu-btn"
          aria-label="Toggle sidebar">&#9776;</button>
        <span class="hash-icon">#</span>
        <span id="room-title">general</span>
        <span class="header-sep">—</span>
        <span id="room-desc" class="room-desc"></span>
        <button id="call-btn" class="icon-btn call-header-btn" title="Start video call">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none">
            <path d="M15 10l4.553-2.276A1 1 0 0121 8.723v6.554a1 1 0 01-1.447.894L15 14M3 8a2 2 0 012-2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span id="call-indicator" class="call-indicator hidden"></span>
        </button>
      </header>

      <div class="messages" id="messages">
        <div class="messages-placeholder">
          <p>No messages yet. Say hello!</p>
        </div>
      </div>

      <div id="connection-banner" class="connection-banner hidden">
        Connecting to Firebase…
      </div>

      <div class="input-row">
        <input
          id="message-input"
          type="text"
          placeholder="Message #general…"
          maxlength="1000"
          autocomplete="off"
          spellcheck="true"
        />
        <button id="send-btn" title="Send (Enter)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2z" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- New-room modal -->
  <div id="room-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h2>New Channel</h2>
      <p>Lowercase letters, numbers, hyphens only.</p>
      <input id="room-name-input" type="text" placeholder="channel-name"
        maxlength="30" autocomplete="off" spellcheck="false"/>
      <div class="modal-actions">
        <button id="room-cancel-btn" class="btn-secondary">Cancel</button>
        <button id="room-create-btn" class="btn-primary">Create</button>
      </div>
    </div>
  </div>

  <!-- ── VIDEO CALL OVERLAY ── -->
  <div id="call-overlay" class="call-overlay hidden">
    <div class="call-topbar">
      <div class="call-topbar-left">
        <span class="call-live-dot"></span>
        <span class="call-topbar-title">Video Call — <strong id="call-room-label">#general</strong></span>
        <span id="call-count-label" class="call-count-badge">1</span>
      </div>
      <div class="call-topbar-right">
        <button id="pip-btn" class="ctrl-btn" title="Picture-in-picture">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
            <rect x="12" y="11" width="8" height="5" rx="1" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="video-grid" class="video-grid"></div>

    <div class="call-controls">
      <button id="mute-btn" class="ctrl-btn" title="Toggle microphone">
        <svg id="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4z"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M19 10a7 7 0 0 1-14 0M12 19v4M8 23h8"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button id="camera-btn" class="ctrl-btn" title="Toggle camera">
        <svg id="cam-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M15 10l4.553-2.276A1 1 0 0121 8.723v6.554a1 1 0 01-1.447.894L15 14M3 8a2 2 0 012-2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <button id="share-screen-btn" class="ctrl-btn" title="Share screen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <rect x="2" y="3" width="20" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 10l3-3 3 3M12 7v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <button id="end-call-btn" class="ctrl-btn end-call-btn" title="Leave call">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M16.5 13.5l2.25-2.25a2.12 2.12 0 0 0 0-3l-1.5-1.5a2.12 2.12 0 0 0-3 0L13 8M7.5 10.5L5.25 8.25a2.12 2.12 0 0 0-3 0l-1.5 1.5a2.12 2.12 0 0 0 0 3L3 15M3 3l18 18"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Firebase v10 compat SDK (works without a bundler) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="app.js"></script>
  <script src="video.js"></script>
